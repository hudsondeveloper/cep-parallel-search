name: cep-parallel-search

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para verificar hist√≥rico de tags

      # Verificar se a tag foi criada a partir da branch principal
      - name: Verificar branch de origem da tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG_NAME"
          
          # Obter o commit da tag
          TAG_COMMIT=$(git rev-list -n 1 $TAG_NAME)
          echo "Commit da tag: $TAG_COMMIT"
          
          # Verificar se o commit est√° na branch main ou master
          if git branch -r --contains $TAG_COMMIT | grep -E 'origin/(main|master)'; then
            echo "‚úÖ Tag criada a partir da branch principal"
          else
            echo "‚ùå ERRO: Tag n√£o foi criada a partir da branch principal (main/master)"
            exit 1
          fi

      # Log de auditoria - registrar quem est√° publicando
      - name: Log de auditoria
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TAG_COMMIT=$(git rev-list -n 1 $TAG_NAME)
          COMMIT_AUTHOR=$(git log -1 --format='%an <%ae>' $TAG_COMMIT)
          
          echo "üìã Informa√ß√µes da publica√ß√£o:"
          echo "   Tag: $TAG_NAME"
          echo "   Commit: $TAG_COMMIT"
          echo "   Autor do commit: $COMMIT_AUTHOR"
          echo "   Usu√°rio GitHub que fez push: ${{ github.actor }}"
          echo "   Reposit√≥rio: ${{ github.repository }}"
          echo "   Evento: ${{ github.event_name }}"
          
          # Se houver uma lista de usu√°rios autorizados no secret, verificar
          if [ -n "${{ secrets.AUTHORIZED_PUBLISHERS }}" ]; then
            AUTHORIZED_USERS="${{ secrets.AUTHORIZED_PUBLISHERS }}"
            if echo "$AUTHORIZED_USERS" | grep -q "${{ github.actor }}"; then
              echo "‚úÖ Usu√°rio autorizado"
            else
              echo "‚ö†Ô∏è  ATEN√á√ÉO: Usu√°rio n√£o est√° na lista de autorizados"
              echo "   Usu√°rios autorizados: $AUTHORIZED_USERS"
            fi
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          # Autentica√ß√£o npm: use NPM_TOKEN secret OU configure trusted publisher no npm para OIDC
          # Op√ß√£o 1 (Token tradicional): Configure NPM_TOKEN como secret no GitHub
          #   Settings > Secrets and variables > Actions > New repository secret > NPM_TOKEN
          # Op√ß√£o 2 (OIDC - mais seguro): Configure trusted publisher no npm
          #   npm profile set trusted-publishers --github-org SEU_ORG --github-repo SEU_REPO
          #   Ou via npmjs.com: Account Settings > Access Tokens > Trusted Publishers
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Ensure npm 11.5.1 or later is installed
      - name: Update npm
        run: npm install -g npm@latest
      
      # Verificar autentica√ß√£o npm
      - name: Verificar autentica√ß√£o npm
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  NPM_TOKEN n√£o configurado"
            echo "üìù Configurando autentica√ß√£o via OIDC (se trusted publisher estiver configurado)"
            echo "üí° Para usar token tradicional, configure NPM_TOKEN como secret no GitHub"
          else
            echo "‚úÖ NPM_TOKEN configurado"
          fi
          # Verificar se est√° autenticado
          npm whoami --registry=https://registry.npmjs.org || echo "‚ö†Ô∏è  N√£o autenticado (pode ser normal se usar OIDC)"
      
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
      
      # Verificar se a vers√£o da tag corresponde √† vers√£o do package.json
      - name: Verificar vers√£o
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${TAG_NAME#v}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "Vers√£o da tag: $TAG_VERSION"
          echo "Vers√£o do package.json: $PACKAGE_VERSION"
          
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "‚ùå ERRO: Vers√£o da tag ($TAG_VERSION) n√£o corresponde √† vers√£o do package.json ($PACKAGE_VERSION)"
            exit 1
          fi
          
          echo "‚úÖ Vers√µes correspondem"
      
      - name: Publish to npm
        run: npm publish --provenance --access public